<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Airports</title>
		<script src='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
		<link href='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />
		<style>
			body {
			  margin: 0;
			  padding: 0;
			}

			h2,
			h3 {
			  margin: 10px;
			  font-size: 1.2em;
			  font-family: 'open_sansbold';
			}

			h3 {
			  font-size: 1em;
			  font-family: 'open_sansbold';
			}

			p {
			  font-size: 0.85em;
			  margin: 10px;
			  text-align: left;
			  font-family: 'open_sansregular';
			}

			@font-face {
			    font-family: 'open_sansbold';
			    src: url('fonts/opensans-bold-webfont.woff2') format('woff2'),
			         url('fonts/opensans-bold-webfont.woff') format('woff');
			    font-weight: normal;
			    font-style: normal;
			}
			
			@font-face {
			    font-family: 'open_sansregular';
			    src: url('fonts/opensans-regular-webfont.woff2') format('woff2'),
			         url('fonts/opensans-regular-webfont.woff') format('woff');
			    font-weight: normal;
			    font-style: normal;
			}

			/* MAPPPPPP */
			#map {
			  position: absolute;
			  top: 0;
			  bottom: 0;
			  width: 100%;
			}


			/* LAYERS: top left */
			#menu {
		        background: #fff;
		        position: absolute;
		        z-index: 1;
		        top: 20px;
		        left: 20px;
		        border-radius: 3px;
		        width: 150px;
		        border: 1px solid rgba(0, 0, 0, 0.4);
		        font-family: 'open_sansregular', sans-serif;
		    }
		    #menu a {
		        font-size: 13px;
		        color: #404040;
		        display: block;
		        margin: 0;
		        padding: 0;
		        padding: 10px;
		        text-decoration: none;
		        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
		        text-align: center;
		    }
		    #menu a:last-child {
		        border: none;
		    }
		    #menu a:hover {
		        background-color: #f8f8f8;
		        color: #404040;
		    }
		    #menu a.active {
		        background-color: #3887be;
		        color: #ffffff;
		    }
		    #menu a.active:hover {
		        background: #3074a4;
		    }




			/*INFO: top right */
			.map-overlay {
			  position: absolute;
/*			  bottom: 0;
*/			  background: rgba(255, 255, 255, 0.8);
			  margin-right: 20px;
			  font-family: 'open_sansregular', sans-serif;
			  overflow: auto;
			  border-radius: 3px;
			}

			#city {
			  top: 0;
			  right: 0;
			  height: 480px;
			  margin-top: 20px;
			  width: 350px;
			}

			#features {
/*			  top: 200;
*/			  right: 0;
			  height: 330px;
			  margin-top: 510px;
			  width: 350px;
			  visibility: hidden;
			}



			/* LEGEND: bottom left */
			#legend {
			  padding: 20px;
			  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
/*			  line-height: 20px;
*/			  bottom: 40px;
			  left: 20px;
			  font-family: 'open_sansregular', sans-serif;
			}
			.legend-key {
			  display: inline-block;
			  border-radius: 20%;
			  width: 18px;
			  height: 18px;
			  margin-right: 5px;
			}
			.legend-key-circle {
			  display: inline-block;
			  border-radius: 50%;
			  width: 18px;
			  height: 18px;
			  margin-right: 5px;
			}


			.bold {font-family: 'open_sansbold';}



		</style>
	</head>
	<body>
		<nav id='menu'></nav>
		<div id='map'></div>
		<div class='map-overlay' id='city'>
			<h2><span class='bold'>Alex's Flight Logs (3/2015-5/2020)</span></h2>
			<div>
				<p>Total Distance Flown: <span class='bold'>345130</span>mi
				<br>Total Flights: <span class='bold'>139</span>
				<br>Number of Airlines: <span class='bold'>27</span>, Countries: <span class='bold'>19</span>, Airports: <span class='bold'>54</span>
				<p>Shortest flight: <span class='bold'>PHL</span> to <span class='bold'>JFK</span> (94mi, 11min)
				<br>Longest flight: <span class='bold'>SIN</span> to <span class='bold'>SFO</span> (8446mi, 16h 53m)</p>
				<p>Airport distribution (top countries): <span class='bold'>China</span>: 15, <span class='bold'>United States</span>: 12, <span class='bold'>Japan</span>: 3
				<p>Airports by total visits: <span class='bold'>BOS</span>: 54, <span class='bold'>PEK</span>: 46, <span class='bold'>EWR</span>: 22</p>
				<p>Top routes: <span class='bold'>BOS</span> to <span class='bold'>EWR</span>: 19, <span class='bold'>EWR</span> to <span class='bold'>PEK</span>: 15, <span class='bold'>BOS</span> to <span class='bold'>SFO</span>: 7</p>
				<p>Top airlines: <span class='bold'>United</span>: 70, <span class='bold'>Hainan</span>: 8, <span class='bold'>Air China</span>: 5</p>
				<P><span class='bold'>2015</span>: 29436mi, 10 flights, <span class='bold'>2016</span>: 57999mi, 20 flights, <span class='bold'>2017</span>: 78048mi, 39 flights, <span class='bold'>2018</span>: 76497mi, 24 flights, <span class='bold'>2019</span>: 84043mi, 31 flights, <span class='bold'>2020</span>: 19103mi, 15 flights</p>
				<p><span class='bold'>Domestic</span>: 69296mi, 81 flights, <span class='bold'>International</span>: 275833mi, 58 flights</p>
				<p><span class='bold'>Business</span>: 123047mi, 37 flights, <span class='bold'>Economy</span>: 216096mi, 98 flights</p>

			</div>
		</div>
		<div class='map-overlay' id='features'>
			<div id='pd'>
			</div>
		</div>
		<div class='map-overlay' id='legend'></div>

	</body>
</html>
<script>
	// TO MAKE THE MAP APPEAR YOU MUST
	// ADD YOUR ACCESS TOKEN FROM
	// https://account.mapbox.com
	mapboxgl.accessToken = 'pk.eyJ1IjoicGljcmF6eTIiLCJhIjoiY2thMG1vdDQ0MHMxajNtcXI1ZnpiYnFpZiJ9.iYJgxRpR27z5rtZGoGXl2g';
	// mapboxgl.accessToken = 'pk.eyJ1IjoicGljcmF6eTIiLCJhIjoiY2thMG1xMnR2MDMxeDNtazBjYjVrcjAxZSJ9.Ku2z0w2wiQ9RmhN8oTbbYQ'
	var years = [2015, 2016, 2017, 2018, 2019, 2020]
	var route_year_ids = []
	var airport_year_ids = []

	var first_month = 3
	var last_month = 5

	for(var i = 0; i < years.length; i++) {
		route_year_ids.push('routes_' + years[i])
		airport_year_ids.push('airports_' + years[i])
	}


	function get_time(hours) {
		return [Math.trunc(hours), Math.trunc(60 *(hours - Math.trunc(hours)))]
	}
	function get_time_str(hours) {
		if(get_time(hours)[0] == 0) {
			return get_time(hours)[1] + 'min'
		} else {
			return get_time(hours)[0] + 'h ' + get_time(hours)[1] + 'm'						
		}
	}

	var map = new mapboxgl.Map({
		container: 'map', // container id
		style: 'mapbox://styles/picrazy2/cka8a1z1r0d591io0ebssgmz3',
		center: [-120, 45],
		zoom: 1.8
	});


	map.on('load', function() {


		map.moveLayer('admin-1-boundary-bg', 'settlement-subdivision-label')
		map.moveLayer('admin-0-boundary-bg', 'settlement-subdivision-label')
		map.moveLayer('admin-1-boundary', 'settlement-subdivision-label')
		map.moveLayer('admin-0-boundary', 'settlement-subdivision-label')
		map.moveLayer('admin-0-boundary-disputed', 'settlement-subdivision-label')


		function add_routes(file_name, visibility) {
			map.addSource(file_name, {
				'type': 'geojson',
				'data': 'https://picrazy2.github.io/flightlog/' + file_name + '.geojson'
			});

			map.addLayer({
				'id': file_name,
				'source': file_name,
				'type': 'line',
				'layout': {
					'visibility': visibility
				},
				'paint': {
					'line-color': ["match",["get", "domint"],['Domestic'],'#087E8B','#FF5A5F'],
					'line-width': [
					  "interpolate",
					  ["linear"],
					  ["get", "count"],
					  1,
					  2,
					  19,
					  19
					]

				}
			}, 'admin-1-boundary-bg');			
		}


		function add_airports(file_name, visibility) {
			map.addSource(file_name, {
				'type': 'geojson',
				'data': 'https://picrazy2.github.io/flightlog/' + file_name + '.geojson'
			});

			map.addLayer({
				'id': file_name,
				'source': file_name,
				'type': 'symbol',
				'layout': {
					'icon-image': "airport-15",
					'icon-allow-overlap': true,
					'icon-size': [
					  "interpolate",
					  ["linear"],
					  ["zoom"],
					  0,
					  [
					    "interpolate",
					    ["linear"],
					    ["get", "total"],
					    0,
					    0.5,
					    60,
					    2
					  ],
					  22,
					  [
					    "interpolate",
					    ["linear"],
					    ["get", "total"],
					    0,
					    5,
					    60,
					    10
					  ]
					],
					'visibility': visibility
				},
				'paint': {}
			}, 'admin-1-boundary-bg');
		}


		function add_s(num, s) {
			if(num == 1) {
				return s
			} else {
				return s + 's'
			}
		}

		function parse_hist(hist, s) {
			var hist_split = hist.split(';')
			var hist_str = ''
			for(var i = 0; i < hist_split.length; i++) {
				var further_split = hist_split[i].split(',')
				if(i > 0) {
					hist_str += ', '
				}
				hist_str += further_split[0] + ': <span class=\'bold\'>' + further_split[1] + '</span> ' + add_s(further_split[1], s)
			}
			return hist_str	
		}

		function hover_routes(name) {
			var path_popups = []
			map.on('mouseenter', name, function(e) {
				if(path_popups.length == 0) {
					var start = e.features[0].properties.start_iata
					var end = e.features[0].properties.end_iata
					var origin_hist_split = e.features[0].properties.origin_hist.split(';')
					var origin_hist_str = ''
					for(var i = 0; i < origin_hist_split.length; i++) {
						var further_split = origin_hist_split[i].split(',')
						if(i > 0) {
							origin_hist_str += ', '
						}
						if(further_split[0] == start) {
							origin_hist_str += start + '-' + end + ': <span class=\'bold\'>' + further_split[1] + '</span> ' + add_s(further_split[1], 'time')
						} else {
							origin_hist_str += end + '-' + start + ': <span class=\'bold\'>' + further_split[1] + '</span> ' + add_s(further_split[1], 'time')
						}
					}

					path_popups.push(new mapboxgl.Popup({closeButton: false})
						.setLngLat(e.lngLat)
						.setHTML(
							'<p style=\'font-size:15px\'>Between <span class=\'bold\'>' + start + '</span> and <span class=\'bold\'>' + end + '</span>'
							+'<br>' + e.features[0].properties.start_city_country.split(',')[0] + ' and ' + e.features[0].properties.end_city_country.split(',')[0] + '</p>'
							+'<p style=\'font-size:13px\'>' + e.features[0].properties.domint + ', <span class=\'bold\'>' + Math.trunc(e.features[0].properties.dist) + '</span>mi, ' + get_time_str(e.features[0].properties.dur)
							+'<br> Flown <span class=\'bold\'>' + e.features[0].properties.count + '</span> ' + add_s(e.features[0].properties.count, 'time') + ' (' +  origin_hist_str + ')'
							+'<br>' + parse_hist(e.features[0].properties.class_hist, 'time') 
							+'<br>' + parse_hist(e.features[0].properties.airline_hist, 'time')  
							+'<br>First time: <span class=\'bold\'>' + e.features[0].properties.earliest_date + '</span>'
							+'<br>Last time: <span class=\'bold\'>' + e.features[0].properties.latest_date + '</span>'
							+'</p>'
							)
						.addTo(map));
				}
			});

			map.on('mouseleave', name, function() {
				for(var i = 0; i < path_popups.length; i++) {
					path_popups[i].remove()
				}
				path_popups = []

			});			
		}



		function click_airports(name) {
			map.on('click', name, function(e) {
				var dest_set = new Set()
				var dep_hist = e.features[0].properties.dep_dest_hist.split(';')
				var arr_hist = e.features[0].properties.arr_dest_hist.split(';')
				for(var i = 0; i < dep_hist.length; i++) {
					dest_set.add(dep_hist[i].split(',')[0])
				}
				for(var i = 0; i < arr_hist.length; i++) {
					dest_set.add(arr_hist[i].split(',')[0])
				}

				var dest_str = ''
				console.log()
				for(var i = 0; i < Array.from(dest_set).length; i++) {
					dest_str += Array.from(dest_set)[i]
					if(i < Array.from(dest_set).length - 1) {
						dest_str += ', '
					}
				}

				new mapboxgl.Popup()
					.setLngLat(e.lngLat)
					.setHTML(
						'<p style=\'font-size:14px\'><span class=\'bold\'>' + e.features[0].properties.IATA + ' ' + e.features[0].properties.Name + '</span>'
						+ '<br>' + e.features[0].properties.City + ', ' + e.features[0].properties.Country + '</p>'

						+ '<p style=\'font-size:13px\'>Departures: <span class=\'bold\'>' + e.features[0].properties.dep_count+ '</span>'
						+ '<br>Arrivals: <span class=\'bold\'>' + e.features[0].properties.arr_count + '</span>'
						+ '<br>Connections: <span class=\'bold\'>' + e.features[0].properties.arr_conn_count+ '</span>'
						+ '<br>Flown from/to: ' + dest_str
						+ '<br>' + parse_hist(e.features[0].properties.full_year_hist, 'visit')
						+ '</p>'
						)
					.addTo(map);
			});
				 
				// Change the cursor to a pointer when the mouse is over the states layer.
			map.on('mouseenter', name, function() {
				map.getCanvas().style.cursor = 'pointer';
			});
				 
				// Change it back to a pointer when it leaves.
			map.on('mouseleave', name, function() {
				map.getCanvas().style.cursor = '';
			});

		}





		add_routes('routes_all', 'visible')
		add_airports('airports_all', 'visible')

		hover_routes('routes_all');
		click_airports('airports_all');

		for(var i = 0; i < years.length; i++) {
			add_routes('routes_' + years[i], 'none')
			add_airports('airports_' + years[i], 'none')
			hover_routes('routes_' + years[i])
			click_airports('airports_' + years[i])		}



		var yearIds = ['all'].concat(years);
		var toggleableLayerLabels = ['All Years'].concat(years);

		var links = []

		for (var i = 0; i < yearIds.length; i++) {
	        var link = document.createElement('a');
	        link.href = '#';
	        if (i == 0) {        
	        	link.className = 'active';
			} else {
				link.className = '';
			}
			link.id = yearIds[i]
	        link.textContent = toggleableLayerLabels[i];

	        var layers = document.getElementById('menu');
	        layers.appendChild(link);
	        links.push(link)
	    }

	    for (var i = 0; i < yearIds.length; i++) {
	        links[i].onclick = function(e) {
	            var clickedLayer = this.id;
	            e.preventDefault();
	            e.stopPropagation();

	            var visibility = map.getLayoutProperty('routes_' + clickedLayer, 'visibility');

	            if (visibility === 'visible') {
	                map.setLayoutProperty('routes_' + clickedLayer, 'visibility', 'none');
	                map.setLayoutProperty('airports_' + clickedLayer, 'visibility', 'none');
	                this.className = '';
	            } else {
	                this.className = 'active';
	                map.setLayoutProperty('routes_' + clickedLayer, 'visibility', 'visible');
	                map.setLayoutProperty('airports_' + clickedLayer, 'visibility', 'visible');
	            }

	            if (visibility !== 'visible') {
					for (var j = 0; j <  yearIds.length; j++) {
	            		if (this.id !== links[j].id) {
	            			var clicked = links[j].id;
	            			var vis = map.getLayoutProperty('routes_' + clicked, 'visibility');
	            			if (vis == 'visible') {
				                map.setLayoutProperty('routes_' + clicked, 'visibility', 'none');
				                map.setLayoutProperty('airports_' + clicked, 'visibility', 'none');
				                links[j].className = '';
				            }
	            		}
	            	}
	            } 


	   //          layers = [];
	   //          colors = [];
	   //          if (this.id === toggleableLayerIds[5]) {
	   //          	layers = dest_layers;
	   //          	colors = dest_colors;
	   //          } else if (this.id === toggleableLayerIds[4]) {
	   //          	layers = dur_layers;
	   //          	colors = dur_colors;
	   //          }

	   //          if (toggleableLayerIds.slice(4, toggleableLayerIds.length).includes(this.id)) {
	   //          	while (legend.lastElementChild) {
				// 	    legend.removeChild(legend.lastElementChild);
				// 	  }
	   //          	for (i = 0; i < layers.length; i++) {
				// 	  var layer = layers[i];
				// 	  var color = colors[i];
				// 	  var item = document.createElement('div');
				// 	  var key = document.createElement('span');

				// 	  key.className = 'legend-key';
				// 	  key.style.backgroundColor = color;

				// 	  var value = document.createElement('span');
				// 	  value.innerHTML = layer;
				// 	  item.appendChild(key);
				// 	  item.appendChild(value);
				// 	  legend.appendChild(item);
				// 	}
				// }

	        };
	    }


   });

</script>
 

</html>